<html>

<head>
  <title>Object Detection</title>
  <script src="https://unpkg.com/ml5@0.12.2/dist/ml5.min.js"></script>
</head>

<body style="margin: 0;">
  <button id="captureScreenButton" style="display: none" onclick="getScreenCapture()">
    capture screen
  </button>
  <video id="video" autoplay muted style="display: none"></video>
  <canvas id="canvas" style="width: 100%; height: 100%"></canvas>
</body>

<script>
  let ws;
  function initWebsocket() {
    ws = new WebSocket("wss://" + location.host);
    ws.addEventListener("open", () => {
      console.log("opened websocket connection");
    });
    ws.addEventListener("close", () => {
      console.log("websocket connection closed");
      setTimeout(() => {
        initWebsocket();
      }, 1000);
    });
  }
  function isWebsocketConnected() {
    return ws.readyState == WebSocket.OPEN;
  }
  function sendMessage(...message) {
    if (isWebsocketConnected()) {
      ws.send(JSON.stringify(message));
    }
  }
  initWebsocket()

  let captureStream;
  async function getScreenCapture() {
    if (captureStream) {
      return;
    }

    try {
      captureStream = await navigator.mediaDevices.getDisplayMedia({
        video: true,
        audio: false,
      });
    } catch (error) {
      console.error(`Error: ${error}`);
    }

    captureScreenButton.style.display = "none";
    captureStream.oninactive = () => {
      captureStream = null;
      captureScreenButton.style.display = "";
    };

    video.srcObject = captureStream;
    video.play();
  }
  video.onloadeddata = () => {
    console.log("loaded data");
    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
    detect();
  };

  // ML5.js
  let objectDetector;
  let objects;
  async function setupObjectDetection() {
    objectDetector = await ml5.objectDetector("cocossd", onModelLoaded);
  }
  function onModelLoaded() {
    console.log("model ready");
    captureScreenButton.style.display = "";
  }
  function detect() {
    if (!captureStream) {
      return;
    }
    // console.log("detect");
    objectDetector.detect(video, onObjectDetection);
  }

  function onObjectDetection(error, results) {
    // console.log(error, results);
    if (error) {
      console.log(error);
      return;
    }
    objects = results.filter((obj) => obj.label !== "person");

    if (objects) {
      let outputObj = []
      for (const obj of objects) {
        const x = obj.x / video.videoWidth;
        const y = obj.y / video.videoHeight;
        const width = obj.width / video.videoWidth;
        const height = obj.height / video.videoHeight;

        outputObj.push({ x1: x, y1: y, x2: x + width, y2: y + height, label: obj.label });
      }

      // console.log('sending', outputObj)
      sendMessage(outputObj)
      draw()
    }

    detect();
  }

  const canvasContext = canvas.getContext("2d");
  function draw() {
    let color = "green"
    const ctx = canvasContext;
    const { width, height } = canvas;

    ctx.fillStyle = "#000000";
    ctx.fillRect(0, 0, width, height);

    let distance = Infinity, closestIndex = null;

    ctx.drawImage(video, 0, 0);
    if (objects.length > 1) {
      for (let i = 0; i < objects.length; i += 1) {
        const prediction = objects[i]
        let current = { x: (prediction.x1 + prediction.x2) / 2, y: (prediction.y1 + prediction.y2) / 2 };

        let d = Math.sqrt(Math.pow(current.x - 0.5, 2) + Math.pow(current.y - 0.5, 2));

        if (d < distance) {
          distance = d;
          closestIndex = i;
        }
      }
      let closest = objects.splice(closestIndex, 1)[0]

      ctx.font = "16px Arial";
      ctx.fillStyle = "red";
      ctx.fillText(closest.label, closest.x + 4, closest.y + 16);

      ctx.beginPath();
      ctx.rect(
        closest.x,
        closest.y,
        closest.width,
        closest.height
      );
      ctx.strokeStyle = "red";
      ctx.stroke();
      ctx.closePath();
    } else {
      color = "red";
    }

    for (let i = 0; i < objects.length; i += 1) {
      ctx.font = "16px Arial";
      ctx.fillStyle = color;
      ctx.fillText(objects[i].label, objects[i].x + 4, objects[i].y + 16);

      ctx.beginPath();
      ctx.rect(
        objects[i].x,
        objects[i].y,
        objects[i].width,
        objects[i].height
      );
      ctx.strokeStyle = color;
      ctx.stroke();
      ctx.closePath();
    }
  }

  setupObjectDetection();
</script>

</html>